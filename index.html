<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Backpage Bot</title>
    <link rel="stylesheet" href="libs/bootstrap.min.css">
    <link rel="stylesheet" href="main.css">
  </head>
  <body>
  <div class="container">
    <h1 class="text-center">Backpage Bot</h1>
    <form>
      <div class="form-group">
      <input type="radio" name="adType" id="local" value="local" checked>Local ad<br>
      <input type="radio" name="adType" id="multiple" value="multiple">Multiple cities<br>
      </div>
      <div class="form-group">
        <label for="category">Category</label>
        <select class="form-control" id="category" required>
        </select>
      </div>
      <div class="form-group">
        <label for="title">Title</label>
        <input type="text" class="form-control" id="title" placeholder="Title" required>
      </div>
      <div class="form-group">
        <label for="description">Description</label>
        <textarea type="text" class="form-control" id="description" required></textarea>
      </div>
      <div class="form-group">
        <label for="city">City</label>
        <input type="text" class="form-control" id="city" placeholder="City" required>
      </div>
      <div class="form-group">
        <label for="location">Location/Address</label>
        <input type="text" class="form-control" id="location" placeholder="Location" required>
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" class="form-control" id="email" placeholder="Email" required>
      </div>
      <div class="form-group">
        <label for="phone">Phone</label>
        <input type="text" class="form-control" id="phone" placeholder="phone" required>
      </div>
      <div class="form-group">
        <button class="btn btn-primary form-control" type="button" onclick="saveData()">Save Ad</button><br/><br/>
        <div class="form-group">
          <label for="bp_email">Backpage Email</label>
          <input type="email" class="form-control" id="bp_email" placeholder="Backpage Email" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" class="form-control" id="password" placeholder="Password" required>
        </div>
        <button class="btn btn-warning form-control" type="button" onclick="startScrape()">Submit Saved Ads to Backpage</button>
      </div>
    </form>
    <ul id="ads">

    </ul>
  </div>
  <script>
    // You can also require other files to run in this process
    require('./renderer.js')

  </script>
  <script>window.$ = window.jQuery = require('./libs/jquery-3.2.1.min.js');</script>
  <script src="libs/bootstrap.min.js"></script>
  <script>

     const flat = require('node-flat-db');
     const storage = require('node-flat-db/file-async');

     const db = flat('data/backpage.json', { storage });

     const ads = db('ads').map('title');

     for(var x= 0; x< db('ads').size(); x++){
         $('#ads').append(`<li id="${ads[x]}">` + ads[x] + ` <button class="text-danger" id="delete" onclick="deleteAd(${ads[x]})">x</button></li>`)
     }

     function saveData(){
         var category = $('#category').val()
         var title = $('#title').val()
         var desc = $('#description').val()
         var found = db('ads').find({title: title})
         var location = $('#location').val()
         var city = $('#city').val()
         var email = $('#email').val()
         var phone = $('#ephone').val()
         if(!found && category !== '' && title != '' && desc != '' && phone != '' && email != '' && location != '' && city != ''){
             db('ads').push({
                 category: category,
                 title: title,
                 description: desc,
                 email: email,
                 phone: phone,
                 location: location,
                 city: city
             })
                 .then(ad => $('#ads').append(`<li id="${title}">` + title + ` <button class="text-danger" id="delete" onclick="deleteAd(${title})">x</button></li>`))
             
             $('#category').val()
             $('#title').val('')
             $('#description').val('')
             $('#city').val('')
             $('#location').val('')
             $('#email').val('')
             $('#phone').val('')
         }

     }
     function deleteAd(title){
         console.log('deleted', title.id);
         db('ads').remove({ title: title.id })
         $('#' + title.id).remove();
     }
   </script>

  <script>
    var postings = {
        "adult jobs": {
            "category": "4389",
            "section": "4381"
        },
        "body rubs": {
            "category": "108649",
            "section": "4381"
        },
        "domination & fetish": {
            "category": "2208114",
            "section": "4381"
        },
        "escorts": {
            "category": "4443",
            "section": "4381"
        },
        "male escorts": {
            "category": "2855806",
            "section": "4381"
        },
        "phone & websites": {
            "category": "1232880",
            "section": "4381"
        },
        "transsexual escorts": {
            "category": "1819761",
            "section": "4381"
        },
        "auto parts": {
            "category": "78693",
            "section": "153676"
        },
        "automotive services": {
            "category": "20661",
            "section": "153676"
        },
        "autos for sale": {
            "category": "4423",
            "section": "153676"
        },
        "antiques for sale": {
            "category": "4422",
            "section": "4378"
        },
        "appliances for sale": {
            "category": "5431",
            "section": "4378"
        },
        "boats/motorcycles": {
            "category": "5433",
            "section": "4378"
        },
        "business for sale": {
            "category": "2018354",
            "section": "4378"
        },
        "clothing for sale": {
            "category": "5434",
            "section": "4378"
        },
        "electronics": {
            "category": "4424",
            "section": "4378"
        },
        "farm & garden": {
            "category": "2018353",
            "section": "4378"
        },
        "free": {
            "category": "5436",
            "section": "4378"
        },
        "furniture for sale": {
            "category": "4425",
            "section": "4378"
        },
        "household items": {
            "category": "2018352",
            "section": "4378"
        },
        "miscellaneous": {
            "category": "5419",
            "section": "4376"
        },
        "pets for sale": {
            "category": "4428",
            "section": "4378"
        },
        "sports equipment and guns for sale": {
            "category": "5435",
            "section": "4378"
        },
        "tickets for sale": {
            "category": "4431",
            "section": "4378"
        },
        "tools for sale": {
            "category": "5437",
            "section": "4378"
        },
        "want-trade": {
            "category": "5440",
            "section": "4378"
        },
        "yard sales": {
            "category": "4433",
            "section": "4378"
        },
        "childcare": {
            "category": "78688",
            "section": "4382"
        },
        "classes/workshops": {
            "category": "4445",
            "section": "4382"
        },
        "general": {
            "category": "4447",
            "section": "4382"
        },
        "groups": {
            "category": "20659",
            "section": "4382"
        },
        "lost & found": {
            "category": "4446",
            "section": "4382"
        },
        "volunteers": {
            "category": "8776",
            "section": "4382"
        },
        "men seeking men": {
            "category": "4456",
            "section": "4383"
        },
        "men seeking women": {
            "category": "4454",
            "section": "4383"
        },
        "transgender": {
            "category": "2931422",
            "section": "4383"
        },
        "women seeking men": {
            "category": "4453",
            "section": "4383"
        },
        "women seeking women": {
            "category": "4452",
            "section": "4383"
        },
        "accounting/financial": {
            "category": "26363",
            "section": "4373"
        },
        "administrative/office": {
            "category": "4394",
            "section": "4373"
        },
        "computer/technical": {
            "category": "4386",
            "section": "4373"
        },
        "customer service": {
            "category": "26431",
            "section": "4373"
        },
        "domestic jobs": {
            "category": "5414",
            "section": "4373"
        },
        "driver/delivery/courier": {
            "category": "4387",
            "section": "4373"
        },
        "education jobs": {
            "category": "4388",
            "section": "4373"
        },
        "focus group/studies": {
            "category": "5413",
            "section": "4373"
        },
        "job wanted/resume": {
            "category": "4392",
            "section": "4373"
        },
        "management/professional": {
            "category": "4393",
            "section": "4373"
        },
        "medical/health jobs": {
            "category": "4391",
            "section": "4373"
        },
        "miscellaneous jobs": {
            "category": "4390",
            "section": "4373"
        },
        "real estate jobs": {
            "category": "2018355",
            "section": "4373"
        },
        "restaurant/retail": {
            "category": "4396",
            "section": "4373"
        },
        "sales & marketing": {
            "category": "4398",
            "section": "4373"
        },
        "salon/spa jobs": {
            "category": "4399",
            "section": "4373"
        },
        "show biz/audition": {
            "category": "4400",
            "section": "4373"
        },
        "trades & labor jobs": {
            "category": "4401",
            "section": "4373"
        },
        "bars/clubs": {
            "category": "2434196",
            "section": "2434192"
        },
        "events": {
            "category": "4451",
            "section": "2434192"
        },
        "salons/nails/spas": {
            "category": "2434197",
            "section": "2434192"
        },
        "restaurants": {
            "category": "2434198",
            "section": "2434192"
        },
        "equipment/instruments": {
            "category": "4439",
            "section": "4380"
        },
        "music instruction": {
            "category": "4440",
            "section": "4380"
        },
        "available/wanted": {
            "category": "4441",
            "section": "4380"
        },
        "musicians services": {
            "category": "4442",
            "section": "4380"
        },
        "plug the band": {
            "category": "4438",
            "section": "4380"
        },
        "commercial": {
            "category": "4417",
            "section": "4376"
        },
        "homes for sale": {
            "category": "4412",
            "section": "4375"
        },
        "land for sale": {
            "category": "4408",
            "section": "4375"
        },
        "real estate wanted": {
            "category": "4415",
            "section": "4375"
        },
        "apartments/houses": {
            "category": "4416",
            "section": "4376"
        },
        "rentals wanted": {
            "category": "5420",
            "section": "4376"
        },
        "roommates": {
            "category": "4421",
            "section": "4376"
        },
        "vacation": {
            "category": "5418",
            "section": "4376"
        },
        "biz opps": {
            "category": "5416",
            "section": "4374"
        },
        "business services": {
            "category": "4402",
            "section": "4374"
        },
        "cleaning services": {
            "category": "4404",
            "section": "4374"
        },
        "computer": {
            "category": "20662",
            "section": "4374"
        },
        "creative services": {
            "category": "153680",
            "section": "4374"
        },
        "financial": {
            "category": "20663",
            "section": "4374"
        },
        "health/beauty services": {
            "category": "4406",
            "section": "4374"
        },
        "home improvement": {
            "category": "153679",
            "section": "4374"
        },
        "labor/moving": {
            "category": "153682",
            "section": "4374"
        },
        "landscape/lawn": {
            "category": "153681",
            "section": "4374"
        },
        "legal services": {
            "category": "20660",
            "section": "4374"
        },
        "misc. services": {
            "category": "4407",
            "section": "4374"
        },
        "real estate services": {
            "category": "20664",
            "section": "4374"
        },
        "massage": {
            "category": "27319",
            "section": "4374"
        }
    }
    
    categoryOptions = Object.keys(postings).reduce((str, key) => {
      return str + '<option value=' + key + '>' + key + '</option>';
    }, '');
    
    $('#category').append(categoryOptions);

    function startScrape(){
        console.log('Logging in to backpage...')
        var Nightmare = require('nightmare');
        var nightmare = Nightmare({ show: true });
        var local = $('#local')[0].checked;
        var multiple = $('#multiple')[0].checked;
        
        var selectDestination = local ? '.mainBody ul li:nth-child(1) a' : '.mainBody ul li:nth-child(2) a' // local should be true or false based on radio button
        
        var localUrl = 'http://posting.anchorage.backpage.com/online/classifieds/PostAdPPI.html/posting.anchorage.backpage.com/?section=4380&category=4438&serverName=anchorage.backpage.com&superRegion=Anchorage'
        
        nightmare.goto('https://my.backpage.com/classifieds/central/index')
        .insert('#centralEmail', $('#bp_email').val())
        .insert('#centralPassword', $('#password').val())
        .wait(100)
        .uncheck('#centralRemember')
        .click('.signIn')
        .wait('h1 a')
        .click('h1 a')
        .wait('#postAnAd a')
        .click('#postAnAd a')
        .wait(selectDestination)
        .click(selectDestination)
        .click('.countryHeader a')
        //.end()
        .then(function(){
            console.log("Action completed")
        })
            
            
        
    }
  </script>
  </body>
</html>

