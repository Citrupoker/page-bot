<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Backpage Bot</title>
    <link rel="stylesheet" href="libs/bootstrap.min.css">
    <link rel="stylesheet" href="main.css">
  </head>
  <body>
  <div class="container">
    <h1 class="text-center">Backpage Bot</h1>
    <form>
      <div class="form-group">
      <input type="radio" name="adType" id="local" value="local" checked>Local ad<br>
      <input type="radio" name="adType" id="multiple" value="multiple">Multiple cities<br>
      </div>
      <div class="form-group">
        <label for="category">Category</label>
        <select class="form-control" id="category" required>
        </select>
      </div>
      <div class="form-group">
        <label for="title">Title</label>
        <input type="text" class="form-control" id="title" placeholder="Title" required>
      </div>
      <div class="form-group">
        <label for="description">Description</label>
        <textarea type="text" class="form-control" id="description" required></textarea>
      </div>
      <div class="form-group">
        <label for="city">City</label>
        <select class="form-control" id="city" required>
      </div>
      <div class="form-group">
        <label for="location">Location/Address</label>
        <input type="text" class="form-control" id="location" placeholder="Location" required>
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" class="form-control" id="email" placeholder="Email" required>
      </div>
      <div class="form-group">
        <label for="phone">Phone</label>
        <input type="text" class="form-control" id="phone" placeholder="phone" required>
      </div>
      <div class="form-group">
        <label for="age">Age</label>
        <input type="text" class="form-control" id="age" placeholder="Age">
      </div>
      <div class="form-group">
        <button class="btn btn-primary form-control" type="button" onclick="saveData()">Save Ad</button><br/><br/>
        <div class="form-group">
          <label for="bp_email">Backpage Email</label>
          <input type="email" class="form-control" id="bp_email" placeholder="Backpage Email" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" class="form-control" id="password" placeholder="Password" required>
        </div>
        <button class="btn btn-warning form-control" type="button" onclick="startScrape()">Submit Saved Ads to Backpage</button>
      </div>
    </form>
    <ul id="ads">

    </ul>
  </div>
  <script>
    // You can also require other files to run in this process
    require('./renderer.js')

  </script>
  <script>window.$ = window.jQuery = require('./libs/jquery-3.2.1.min.js');</script>
  <script src="libs/bootstrap.min.js"></script>
  <script src="postings.js"></script>
  <script src="cities.js"></script>
  <script>

     const flat = require('node-flat-db');
     const storage = require('node-flat-db/file-async');

     const db = flat('data/backpage.json', { storage });

     const ads = db('ads').map('title');

     for(var x= 0; x< db('ads').size(); x++){
         $('#ads').append(`<li id="${ads[x].split(' ').join('_')}">` + ads[x] + ` <button class="text-danger" id="delete" onclick="deleteAd(${ads[x].split(' ').join('_')})">x</button></li>`)
     }

     function saveData(){
         var category = $('#category').val()
         var title = $('#title').val()
         var desc = $('#description').val()
         var found = db('ads').find({title: title})
         var location = $('#location').val()
         var city = $('#city').val().split('_').join(' ')
         var email = $('#email').val()
         var phone = $('#phone').val()
         var age = $('#age').val()
         if(!found && category !== '' && title != '' && desc != '' && phone != '' && email != '' && location != '' && city != ''){
             db('ads').push({
                 category: category,
                 title: title,
                 description: desc,
                 email: email,
                 phone: phone,
                 location: location,
                 city: city,
                 age: age
             })
                 .then(ad => $('#ads').append(`<li id="${title.split(' ').join('_')}">` + title + ` <button class="text-danger" id="delete" onclick="deleteAd(${title.split(' ').join('_')})">x</button></li>`))
             
             $('#category').val()
             $('#title').val('')
             $('#description').val('')
             $('#city').val('')
             $('#location').val('')
             $('#email').val('')
             $('#phone').val('')
             $('#age').val('')
         }

     }
     function deleteAd(title){
         var id = title.id.split('_').join(' ');
         console.log('deleted', id);
         db('ads').remove({ title: id })
         $('#' + title.id).remove();
     }
   </script>

  <script>
    var categoryOptions = Object.keys(postings).sort().reduce((str, key) => {
      return str + '<option value=' + key + '>' + postings[key].original + '</option>';
    }, '');
    var cityOptions = cities.sort().reduce((str, key) => {
      return str + '<option value=' + key.split(' ').join('_') + '>' + key + '</option>';
    }, '');
    
    $('#category').append(categoryOptions);
    $('#city').append(cityOptions);

    function startScrape(){
        console.log('Logging in to backpage...')
        var Nightmare = require('nightmare');
        var nightmare = Nightmare({ show: true });
        var local = $('#local')[0].checked;
        var multiple = $('#multiple')[0].checked;
        
        var selectDestination = local ? '.mainBody ul li:nth-child(1) a' : '.mainBody ul li:nth-child(2) a' // local should be true or false based on radio button
        
        nightmare.goto('https://my.backpage.com/classifieds/central/index')
              .insert('#centralEmail', $('#bp_email').val())
              .insert('#centralPassword', $('#password').val())
              .wait(100)
              .uncheck('#centralRemember')
              .click('.signIn')
              .then(function() {
                var ads = db('ads');
                console.log(ads);
                
                ads.reduce(function(accumulator, ad) {
                  
                  return accumulator.then(function(result) {
                    var localUrl = 'http://posting.' + ad.city + '.backpage.com/online/classifieds/PostAdPPI.html/posting.' + 
                    ad.city +'.backpage.com/?section=' + postings[ad.category].section + '&category=' + 
                    postings[ad.category].category + '&serverName=' + ad.city + '.backpage.com&superRegion=' + ad.city;
                    
                    console.log(localUrl);
                    
                    return nightmare.goto(localUrl)
                      .wait(200)
                      .wait('input[value="Continue"]')
                      .click('input[value="Continue"]')
                      .wait('.largeInput')
                      .insert('input[name="title"]', ad.title)
                      .insert('textarea[name="ad"]', ad.description)
                      .insert('input[name="regionOther"]', ad.location)
                      .insert('input[name="email"]', ad.email)
                      .insert('input[name="emailConfirm"]', ad.email)
                      .exists('input[name="age"]')
                      .then(function(ageInput) {
                        if (ageInput) {
                          return nightmare.insert('input[name="age"]', ad.age || 20);
                        }
                      })
                      .then(function() {
                        return nightmare.exists('input[name="contactPhone"]')
                          .then(function(phoneInput) {
                              if (phoneInput) {
                                return nightmare.insert('input[name="contactPhone"]', ad.phone);
                              }
                          })
                          .then(function() {
                            return nightmare.click('input[name="acceptTerms"]')
                              .click('#submit_button')
                              //.end()
                              .then(function(){
                                  console.log("Action completed");
                              })
                          })
                      })
                  });
                }, Promise.resolve('')).then(function(result){
                    console.log("Done posting all ads");
                });
                
              });
        
    }
  </script>
  </body>
</html>

